package dingding

import (
	"fmt"
	"github.com/eden-framework/courier/client"
	"github.com/eden-framework/srv-identity-platform/internal/clients/client_dingding"
	"github.com/eden-framework/srv-identity-platform/internal/constants/enums"
	"github.com/eden-framework/srv-identity-platform/internal/global"
	"github.com/eden-framework/srv-identity-platform/internal/modules/providers/common"
)

type DingDing struct {
	client *client_dingding.ClientDingDing
}

func NewDingDingProvider(config global.DingDingConfig) *DingDing {
	p := &DingDing{
		client: &client_dingding.ClientDingDing{
			Client: client.Client{
				Host: "oapi.dingtalk.com",
				Mode: "https",
			},
			AppKey:         config.AppKey,
			AppSecret:      config.AppSecret.String(),
			LoginAppID:     config.LoginAppID,
			LoginAppSecret: config.LoginAppSecret.String(),
		},
	}
	p.client.Init()
	return p
}

func (d DingDing) ProviderID() enums.BindType {
	return enums.BIND_TYPE__DINGDING
}

func (d DingDing) ProviderName() string {
	return "钉钉"
}

func (d DingDing) ProviderIcon() string {
	return "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMzJweCIgaGVpZ2h0PSIzMnB4IiB2aWV3Qm94PSIwIDAgMzIgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDU1LjEgKDc4MTM2KSAtIGh0dHBzOi8vc2tldGNoYXBwLmNvbSAtLT4KICAgIDx0aXRsZT5XZUNoYXQ8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZyBpZD0ibGFuZGluZy1wYWdlIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8ZyBpZD0ibGFuZGluZy1wYWdlLWRlZmF1bHQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yNTYuMDAwMDAwLCAtNDk2LjAwMDAwMCkiPgogICAgICAgICAgICA8ZyBpZD0i57yW57uEIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4MC4wMDAwMDAsIDIxMi4wMDAwMDApIj4KICAgICAgICAgICAgICAgIDxnIGlkPSJXZUNoYXQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE3Ni4wMDAwMDAsIDI4NC4wMDAwMDApIj4KICAgICAgICAgICAgICAgICAgICA8Y2lyY2xlIGlkPSLmpK3lnIblvaIiIGZpbGw9IiMzRENEMUEiIGN4PSIxNiIgY3k9IjE2IiByPSIxNiI+PC9jaXJjbGU+CiAgICAgICAgICAgICAgICAgICAgPHBhdGggZD0iTTEzLjcyNDg3Niw4IEMxMC4wMjgwNzQ2LDggNywxMC41ODQ5MjIxIDcsMTMuODY3MTUyIEM3LDE1Ljc2MTc5MyA4LjAwNzU3NDM0LDE3LjMxNzA3MTUgOS42OTA0MTk1MSwxOC41MjIwMzggTDkuMDE3ODEzNjUsMjAuNTk3NzY0NyBMMTEuMzY4NTI4MSwxOS4zODc5MzUxIEMxMi4yMDk5NTM2LDE5LjU1OTI4OTYgMTIuODg0NjM1MSwxOS43MzQ2MDEzIDEzLjcyMzk5MjksMTkuNzM0NjAxMyBDMTMuOTM0OTQxNiwxOS43MzQ2MDEzIDE0LjE0NDQwOCwxOS43MjM5NDg3IDE0LjM1MTc5ODgsMTkuNzA2OTA0NiBDMTQuMjIwNjU5OSwxOS4yNDUxOTEyIDE0LjE0NDQxLDE4Ljc2MjQ3NjYgMTQuMTQ0NDEsMTguMjYxNDk4OCBDMTQuMTQ0NDEsMTUuMjQ5MjU0NSAxNi42Njc1LDEyLjgwMzQwOTggMTkuODYxOTk3NCwxMi44MDM0MDk4IEMyMC4wNzk3NzAyLDEyLjgwMzQwOTggMjAuMjk1NDY3NCwxMi44MTk4NDUyIDIwLjUwOTY4MDMsMTIuODQ0MTkzOSBDMTkuOTI3ODYyOSwxMC4wNjUwOTMzIDE3LjAzMTUzNjgsOCAxMy43MjQ4ODE5LDggTDEzLjcyNDg3Niw4IFogTTExLjU0MDMwODQsMTIuNjU3NjE1NyBDMTEuMDM2NTIyMiwxMi42NTc2MTU3IDEwLjUyNzY5MTksMTIuMzExMjU0OCAxMC41Mjc2OTE5LDExLjc5NDE0NzEgQzEwLjUyNzY5MTksMTEuMjc0OTEwMSAxMS4wMzY1MjIyLDEwLjkzMzQxODMgMTEuNTQwMzA4NCwxMC45MzM0MTgzIEMxMi4wNDQwOTQ2LDEwLjkzMzQxODMgMTIuMzc5OTU0LDExLjI3NTIxNTQgMTIuMzc5OTU0LDExLjc5NDE0NzEgQzEyLjM3OTY1NzMsMTIuMzExMjU0OCAxMi4wNDQwOTY1LDEyLjY1NzYxNTcgMTEuNTQwMzA4NCwxMi42NTc2MTU3IFogTTE2LjI0Njc2MzYsMTIuNjU3NjE1NyBDMTUuNzQyNjc5OCwxMi42NTc2MTU3IDE1LjIzNjgxNiwxMi4zMTEyNTQ4IDE1LjIzNjgxNiwxMS43OTQxNDcxIEMxNS4yMzY4MTYsMTEuMjc0OTEwMSAxNS43NDI2Nzk4LDEwLjkzMzQxODMgMTYuMjQ2NzYzNiwxMC45MzM0MTgzIEMxNi43NTMyMjA3LDEwLjkzMzQxODMgMTcuMDg4NDg0OCwxMS4yNzUyMTU0IDE3LjA4ODQ4NDgsMTEuNzk0MTQ3MSBDMTcuMDg4NDg0OCwxMi4zMTEyNTQ4IDE2Ljc1MjkyMywxMi42NTc2MTU3IDE2LjI0Njc2MzYsMTIuNjU3NjE1NyBaIE0yNiwxOC4xNzkwMTU1IEMyNiwxNS40MjI3MjM3IDIzLjMwOTU3MDYsMTMuMTc0NzM3NiAyMC4yODgwNDAxLDEzLjE3NDczNzYgQzE3LjA4ODQ5NjYsMTMuMTc0NzM3NiAxNC41NjgzNjMzLDE1LjQyMjc0MzkgMTQuNTY4MzYzMywxOC4xNzkwMTU1IEMxNC41NjgzNjMzLDIwLjk0MTM5MzcgMTcuMDg4NDc2OSwyMy4xODQ4MzAyIDIwLjI4ODA0MDEsMjMuMTg0ODMwMiBDMjAuOTU3Njc5NSwyMy4xODQ4MzAyIDIxLjYzMjY1ODYsMjMuMDExOTUzOCAyMi4zMDU1NTQyLDIyLjgzODc3MjYgTDI0LjE1MDM5ODksMjMuODc0ODE0MSBMMjMuNjQ0NTM1MiwyMi4xNTA2MTQ2IEMyNC45OTQxOTc3LDIxLjExMjQ0MzkgMjYsMTkuNzM0OTE4OCAyNiwxOC4xNzkwMjM2IEwyNiwxOC4xNzkwMTU1IFogTTE4LjQzMzQwMDksMTcuMzE3MDY3NSBDMTguMDk4NDMyNCwxNy4zMTcwNjc1IDE3Ljc2MDQ5OTMsMTYuOTc1ODgxIDE3Ljc2MDQ5OTMsMTYuNjI3Mzg4OSBDMTcuNzYwNDk5MywxNi4yODMxNTcyIDE4LjA5ODQzNDMsMTUuOTM2Nzk2NCAxOC40MzM0MDA5LDE1LjkzNjc5NjQgQzE4Ljk0MjIzMTIsMTUuOTM2Nzk2NCAxOS4yNzUxMjIxLDE2LjI4MzE1NzIgMTkuMjc1MTIyMSwxNi42MjczODg5IEMxOS4yNzUxMjIxLDE2Ljk3NTg4MSAxOC45NDIyMzEyLDE3LjMxNzA2NzUgMTguNDMzNDAwOSwxNy4zMTcwNjc1IFogTTIyLjEzMjU4NzIsMTcuMzE3MDY3NSBDMjEuNzk5OTk0LDE3LjMxNzA2NzUgMjEuNDY0NDMyMiwxNi45NzU4ODEgMjEuNDY0NDMyMiwxNi42MjczODg5IEMyMS40NjQ0MzIyLDE2LjI4MzE1NzIgMjEuNzk5OTk0LDE1LjkzNjc5NjQgMjIuMTMyNTg3MiwxNS45MzY3OTY0IEMyMi42MzYzNzM0LDE1LjkzNjc5NjQgMjIuOTc0MzA4NSwxNi4yODMxNTcyIDIyLjk3NDMwODUsMTYuNjI3Mzg4OSBDMjIuOTc0MzA4NSwxNi45NzU4ODEgMjIuNjM2MzczNCwxNy4zMTcwNjc1IDIyLjEzMjU4NzIsMTcuMzE3MDY3NSBaIiBpZD0i5b2i54q2IiBmaWxsPSIjRkZGRkZGIiBmaWxsLXJ1bGU9Im5vbnplcm8iPjwvcGF0aD4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+"
}

func (d DingDing) ProviderEntry() string {
	return fmt.Sprintf("https://oapi.dingtalk.com/connect/qrconnect?appid=%s&response_type=code&scope=snsapi_login&state=DINGDING_{{RANDOM_NUMBER}}&redirect_uri={{REDIRECT_URI}}", global.ProviderConfig.DingDing.LoginAppID)
}

func (d *DingDing) GetUserID(token string) (string, error) {
	resp, err := d.client.GetUserInfoByCode(client_dingding.GetUserInfoByCodeRequest{
		Body: client_dingding.GetUserInfoByCodeBody{
			AuthCode: token,
		},
	})
	if err != nil {
		return "", err
	}

	return resp.UserInfo.UnionID, nil
}

func (d *DingDing) GetUserInfo(userID string) (user common.UserInfo, err error) {
	userIDResp, err := d.client.GetUserIDByUnionID(client_dingding.GetUserIDByUnionIDRequest{
		UnionID: userID,
	})
	if err != nil {
		return
	}

	userInfo, err := d.client.GetUserInfoDetail(client_dingding.GetUserInfoDetailRequest{
		UserID: userIDResp.UserID,
	})
	if err != nil {
		return
	}

	return common.UserInfo{
		UserID: userInfo.UnionID,
		Name:   userInfo.Name,
		Mobile: userInfo.Mobile,
		Email:  userInfo.Email,
	}, nil
}
